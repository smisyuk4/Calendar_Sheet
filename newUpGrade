function onOpen() {    
  var ui = SpreadsheetApp.getUi();   
  ui.createMenu("Меню тренера")
  .addItem("Копирование данных из Google Calendar", "upGradeData")
  .addToUi();  
}

function upGradeData() {
  //подключение к таблице "firstDay"
  var sheet = SpreadsheetApp.openById("1RuVJoEfM9vBaS6YlxUjRXm02GF7zyH0JVpvHZdGq3c8");
  
  //подключение к нужной странице
  var list = sheet.getSheetByName("Тест_календарь");   
  
   //поиск загруженного диапазона в таблицу  
  var firstRowRange = list.getLastRow();  
  pullEvents();  
  var lastRowRange = list.getLastRow();
  var countRow = lastRowRange - firstRowRange;   
 
   //изменение отображения даты, удаление "EET"
  for (var i=0; i<countRow; i++){    
    var getDateCell = list.getRange(firstRowRange+1+i, 1).getValue();   
    var arrayDate = getDateCell.split(" ");   
    var newArrayDate = arrayDate[0] + " " + arrayDate[1]+ " " + arrayDate[2]+ " " + arrayDate[3]+ " " + arrayDate[4];   
    list.getRange(firstRowRange+1+i, 1).setValue(newArrayDate);    
  }   
 
  //поиск ключевых слов в диапазоне ячеек ввод суммы совпадений в соответствующие ячейки
  var textGroup = "группа";
  var textBpt = "бпт";
  var textBptPositive = "бпт+";
  var textNotVisit0 = "пришёл";
  var textNotVisit1 = "пришел";
  var textNotVisit2 = "пришла";
  var textDocument = "справка";       
  
//отлавливание ошибок из-за отсутствия событий в календарном дне
try{
  
  var search = list.getRange(firstRowRange+1, 2, countRow, 4).createTextFinder(textGroup).findAll();
  var searchResult = search.length;
  list.getRange(firstRowRange+1, 7).setValue(searchResult).setBackground("#ceebd0");  
  
  var search2 = list.getRange(firstRowRange+1, 2, countRow, 4).createTextFinder(textBpt).findAll();
  var searchResult2 = search2.length;
  list.getRange(firstRowRange+1, 8).setValue(searchResult2).setBackground("#ceebd0");  
  
  var search3 = list.getRange(firstRowRange+1, 2, countRow, 4).createTextFinder(textBptPositive).findAll();
  var searchResult3 = search3.length;
  list.getRange(firstRowRange+1, 9).setValue(searchResult3).setBackground("#ceebd0");  
  
  var search40 = list.getRange(firstRowRange+1, 2, countRow, 4).createTextFinder(textNotVisit0).findAll();
  var search41 = list.getRange(firstRowRange+1, 2, countRow, 4).createTextFinder(textNotVisit1).findAll();
  var search42 = list.getRange(firstRowRange+1, 2, countRow, 4).createTextFinder(textNotVisit2).findAll();  
  var searchResult4 = search40.length + search41.length + search42.length;
  list.getRange(firstRowRange+1, 10).setValue(searchResult4).setBackground("#ceebd0");  
  
  var search5 = list.getRange(firstRowRange+1, 2, countRow, 4).createTextFinder(textDocument).findAll();
  var searchResult5 = search5.length;
  list.getRange(firstRowRange+1, 11).setValue(searchResult5).setBackground("#ceebd0"); 
  
  list.getRange(firstRowRange+1, 12).setValue("<----- Значения за день");  
  
  //подсчет тренировок персональных клиентов    
  var countColumn = 4;  
  var notEmptyCell=0;   
  var startRow = firstRowRange+1;
  var startCol = 2;
  
  for (var i=0; i<countRow; i++){
    for (var j=0; j<countColumn; j++){
      if (list.getRange(startRow+i, startCol+j).getValue() !== ""){
        notEmptyCell++;
      }      
    }
  }   
  
  var searchResult6 = notEmptyCell - searchResult - searchResult2 - searchResult5;
  list.getRange(firstRowRange+1, 6).setValue(searchResult6).setBackground("#ceebd0");  
  
  } //конец try
  catch(e){   
  }
  
}

function pullEvents() {
  //подключение к "Тест - google calendar"    
  var calendar = CalendarApp.getCalendarById("smisyuk@gmail.com");
  
  //подключение к таблице "firstDay"
  var sheet = SpreadsheetApp.openById("1RuVJoEfM9vBaS6YlxUjRXm02GF7zyH0JVpvHZdGq3c8");
  
  //подключение к нужной странице
  var list = sheet.getSheetByName("Тест_календарь");  
  
  
  //проверка в каком режиме выполнять загрузку событий из календаря
  var modeLoadingEvents = list.getRange(1, 2).isChecked(); 
  
  if (modeLoadingEvents == true){
    var oneDay = new Date();
    Logger.log("automatic MODE");    
  }
  else{
    //поиск даты для загрузки данных   
    var oneDay = list.getRange(1, 5).getValue();   
    Logger.log("manual MODE");
  }  
  
  //отлавливание ошибок из-за отсутствия событий в календарном дне
try{   
  var events = calendar.getEventsForDay(oneDay);       
  
  //поиск последней строки в таблице
  var lastRow = list.getLastRow();          
  
  //выяснение дня недели, месяца, года 
  var todayDate = oneDay.getDate();
  var todayNum = oneDay.getDay();    
  var numMonth = oneDay.getMonth() + 1; 
  var fullYear = oneDay.getFullYear(); 
  
  /*
  0 - Воскресенье, 1 - Понедельник, ..., 6 - Суббота    
  0 - Январь, 1 - Февраль, ..., 11 - Декабрь
  */
  
  //ДОРАБОТАТЬ - если не было событий за день, то создать пустую строку и добавить цвет
  if (todayNum == 6){
    list.getRange(lastRow+2, 6, 1, 6).setBackground("#f0c889");  
    list.getRange(lastRow+2, 12).setValue("<----- Значения за неделю");
  }   
  
  //учитывает высокосность года  
  var lastDayMonth = 28 + ((numMonth + Math.floor(numMonth / 8)) % 2) + 2 % numMonth + 
    Math.floor((1 + (1 - (fullYear % 4 + 2) % (fullYear % 4 + 1)) * 
      ((fullYear % 100 + 2) % (fullYear % 100 + 1)) + (1 - (fullYear % 400 + 2) % (fullYear % 400 + 1))) / numMonth) + 
        Math.floor(1/numMonth) - Math.floor(((1 - (fullYear % 4 + 2) % (fullYear % 4 + 1)) * 
          ((fullYear % 100 + 2) % (fullYear % 100 + 1)) + (1 - (fullYear % 400 + 2) % (fullYear % 400 + 1)))/numMonth);  
  
    //ДОРАБОТАТЬ - если не было событий за день, то создать пустую строку и добавить цвет
  if (todayDate == lastDayMonth){
    list.getRange(lastRow+3, 6, 1, 6).setBackground("#89f097");  
    list.getRange(lastRow+3, 12).setValue("<----- Значения за месяц");
  }     
              
    //загрузка данных из календаря в таблицу
    list.getRange(lastRow+1, 1).setValue(events[0].getStartTime().toLocaleString("ru"));
    var oldTime = list.getRange(lastRow+1, 1).getValue();  
    
    //изменение цвета первой строки новой даты
    list.getRange(lastRow+1, 1, 1, 5).setBackground("#ffd2bd");      
    
    var startRow = lastRow+1;  
    var startColumn = 2;
    var j=lastRow+2;  
    
    for (var i=0; i<events.length; i++){      
      var newTime = events[i].getStartTime().toLocaleString("ru");
      var man = events[i].getTitle();       
      
      if (newTime == oldTime){
        //вправо        
        list.getRange(startRow, startColumn).setValue(man);
        startColumn++;
      }
      else{
        //вниз            
        list.getRange(j, 1).setValue(newTime) 
        list.getRange(j, 2).setValue(man)                
        j++;
        startRow++;
        startColumn = 3;
        oldTime = newTime;
      } 
    }        
    
     } //конец try
catch (e){
    Logger.log("В календаре нет событий для загрузки");
    return;
  }
}















